.model small
.stack 100h
.data
    filename    db "records.txt", 0
    handle      dw ?
    file_buf    db 32 dup(' ')

    sort_buf    db 3200 dup(?)      
    num_recs    dw 0                
    
    in_sr       db 3, ?, 3 dup(' ')
    in_name     db 11, ?, 11 dup(' ')
    in_fam      db 3, ?, 3 dup(' ')
    in_wat      db 4, ?, 4 dup(' ')
    in_flr      db 4, ?, 4 dup(' ')
    in_pls      db 4, ?, 4 dup(' ')

    menu_msg    db 0dh, 0ah, "--- MENU ---"
                db 0dh, 0ah, "1. Add Record"
                db 0dh, 0ah, "2. View Records"
                db 0dh, 0ah, "3. Show Totals"
                db 0dh, 0ah, "4. Sort by ID"
                db 0dh, 0ah, "5. Exit"
                db 0dh, 0ah, "Select: $"
    
    p_sr        db 0dh, 0ah, "Sr# (2 digits): $"
    p_name      db 0dh, 0ah, "Name (10 chars): $"
    p_fam       db 0dh, 0ah, "Family Count: $"
    p_wat       db 0dh, 0ah, "Water Liter: $"
    p_flr       db 0dh, 0ah, "Flour Kg: $"
    p_pls       db 0dh, 0ah, "Pulses Kg: $"
    
    msg_saved   db 0dh, 0ah, "Saved.$"
    msg_sorted  db 0dh, 0ah, "File Sorted by ID.$"
    msg_tot     db 0dh, 0ah, "Total Family: $"
    newline     db 0dh, 0ah, "$"
    
    total_fam   dw 0

.code
main proc
    mov ax, @data
    mov ds, ax

    mov ah, 3dh
    mov al, 0
    lea dx, filename
    int 21h
    jnc close_init
    
    mov ah, 3ch
    mov cx, 0
    lea dx, filename
    int 21h
    
close_init:
    mov bx, ax
    mov ah, 3eh
    int 21h

menu_start:
    lea dx, menu_msg
    mov ah, 09h
    int 21h
    
    mov ah, 01h
    int 21h
    
    cmp al, '1'
    je  goto_add
    cmp al, '2'
    je  goto_view
    cmp al, '3'
    je  goto_totals
    cmp al, '4'
    je  goto_sort
    cmp al, '5'
    je  exit
    jmp menu_start

goto_add:
    lea dx, p_sr
    mov ah, 09h
    int 21h
    lea dx, in_sr
    mov ah, 0ah
    int 21h

    lea dx, p_name
    mov ah, 09h
    int 21h
    lea dx, in_name
    mov ah, 0ah
    int 21h

    lea dx, p_fam
    mov ah, 09h
    int 21h
    lea dx, in_fam
    mov ah, 0ah
    int 21h
    
    lea dx, p_wat
    mov ah, 09h
    int 21h
    lea dx, in_wat
    mov ah, 0ah
    int 21h
    
    lea dx, p_flr
    mov ah, 09h
    int 21h
    lea dx, in_flr
    mov ah, 0ah
    int 21h
    
    lea dx, p_pls
    mov ah, 09h
    int 21h
    lea dx, in_pls
    mov ah, 0ah
    int 21h
    
    mov cx, 32
    mov si, 0
clear_loop:
    mov file_buf[si], ' '
    inc si
    loop clear_loop
    
    mov cl, in_sr[1]
    cmp cl, 0
    je skip_sr
    mov ch, 0
    mov si, 0
copy_sr:
    mov al, in_sr[si+2]
    mov file_buf[si+0], al
    inc si
    loop copy_sr
skip_sr:

    mov cl, in_name[1]
    cmp cl, 0
    je skip_name
    mov ch, 0
    mov si, 0
copy_name:
    mov al, in_name[si+2]
    mov file_buf[si+4], al
    inc si
    loop copy_name
skip_name:

    mov cl, in_fam[1]
    cmp cl, 0
    je skip_fam
    mov ch, 0
    mov si, 0
copy_fam:
    mov al, in_fam[si+2]
    mov file_buf[si+15], al
    inc si
    loop copy_fam
skip_fam:

    mov cl, in_wat[1]
    cmp cl, 0
    je skip_wat
    mov ch, 0
    mov si, 0
copy_wat:
    mov al, in_wat[si+2]
    mov file_buf[si+18], al
    inc si
    loop copy_wat
skip_wat:
    
    mov cl, in_flr[1]
    cmp cl, 0
    je skip_flr
    mov ch, 0
    mov si, 0
copy_flr:
    mov al, in_flr[si+2]
    mov file_buf[si+22], al
    inc si
    loop copy_flr
skip_flr:
    
    mov cl, in_pls[1]
    cmp cl, 0
    je skip_pls
    mov ch, 0
    mov si, 0
copy_pls:
    mov al, in_pls[si+2]
    mov file_buf[si+26], al
    inc si
    loop copy_pls
skip_pls:
    
    mov file_buf[30], 0dh
    mov file_buf[31], 0ah
    
    mov ah, 3dh
    mov al, 1
    lea dx, filename
    int 21h
    mov handle, ax
    
    mov ah, 42h
    mov al, 2
    mov bx, handle
    xor cx, cx
    xor dx, dx
    int 21h
    
    mov ah, 40h
    mov bx, handle
    mov cx, 32
    lea dx, file_buf
    int 21h
    
    mov ah, 3eh
    mov bx, handle
    int 21h
    
    lea dx, msg_saved
    mov ah, 09h
    int 21h
    jmp menu_start

goto_view:
    lea dx, newline
    mov ah, 09h
    int 21h

    mov ah, 3dh
    mov al, 0
    lea dx, filename
    int 21h
    mov handle, ax
    
view_loop:
    mov ah, 3fh
    mov bx, handle
    mov cx, 32
    lea dx, file_buf
    int 21h
    
    cmp ax, 32
    jne view_done
    
    mov cx, 32
    mov si, 0
print_char:
    mov dl, file_buf[si]
    mov ah, 02h
    int 21h
    inc si
    loop print_char
    
    jmp view_loop
    
view_done:
    mov ah, 3eh
    mov bx, handle
    int 21h
    jmp menu_start

goto_totals:
    mov total_fam, 0
    
    mov ah, 3dh
    mov al, 0
    lea dx, filename
    int 21h
    mov handle, ax
    
total_loop:
    mov ah, 3fh
    mov bx, handle
    mov cx, 32
    lea dx, file_buf
    int 21h
    
    cmp ax, 32
    jne show_total

    xor cx, cx    

    mov al, file_buf[15]
    cmp al, '0'
    jl check_d2   
    cmp al, '9'
    jg check_d2
    sub al, 30h
    mov cl, al    
    
check_d2:
    mov al, file_buf[16]
    cmp al, '0'
    jl add_to_tot
    cmp al, '9'
    jg add_to_tot
    sub al, 30h
    
    push ax
    mov al, cl
    mov bl, 10
    mul bl
    mov cl, al
    pop ax
    
    add cl, al    

add_to_tot:
    xor ch, ch
    add total_fam, cx
    jmp total_loop

show_total:
    mov ah, 3eh
    mov bx, handle
    int 21h
    
    lea dx, msg_tot
    mov ah, 09h
    int 21h
    
    mov ax, total_fam
    mov bl, 10
    div bl
    mov bx, ax
    
    mov dl, bl
    add dl, 30h
    mov ah, 02h
    int 21h
    
    mov dl, bh
    add dl, 30h
    mov ah, 02h
    int 21h

    jmp menu_start

goto_sort:
    mov ah, 3dh
    mov al, 0
    lea dx, filename
    int 21h
    mov handle, ax

    mov ah, 3fh
    mov bx, handle
    mov cx, 3200
    lea dx, sort_buf
    int 21h
    
    mov bl, 32
    div bl
    mov ah, 0
    mov num_recs, ax
    
    mov ah, 3eh
    mov bx, handle
    int 21h

    cmp num_recs, 1
    jle sort_save

    mov cx, num_recs
    dec cx
    
outer_sort_loop:
    push cx
    mov si, 0
    
inner_sort_loop:
    mov al, sort_buf[si]
    cmp al, sort_buf[si+32]
    jg  swap_records
    jl  next_iter
    
    mov al, sort_buf[si+1]
    cmp al, sort_buf[si+33]
    jg  swap_records
    
    jmp next_iter

swap_records:
    mov bx, 0
swap_byte_loop:
    mov al, sort_buf[si+bx]
    mov dl, sort_buf[si+bx+32]
    mov sort_buf[si+bx], dl
    mov sort_buf[si+bx+32], al
    inc bx
    cmp bx, 32
    jne swap_byte_loop

next_iter:
    add si, 32
    loop inner_sort_loop
    
    pop cx
    loop outer_sort_loop

sort_save:
    mov ah, 3ch
    mov cx, 0
    lea dx, filename
    int 21h
    mov handle, ax
    
    mov ax, num_recs
    mov bx, 32
    mul bx
    mov cx, ax
    
    mov ah, 40h
    mov bx, handle
    lea dx, sort_buf
    int 21h
    
    mov ah, 3eh
    mov bx, handle
    int 21h
    
    lea dx, msg_sorted
    mov ah, 09h
    int 21h
    
    jmp menu_start

exit:
    mov ah, 4ch
    int 21h

main endp
end main
